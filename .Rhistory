View(hs_unmatched_final)
576-87
names(gsrp_cdc_join)
names(all_matched_pairs)
save.image("E:/2024_Nov27_Received/Processed Data/miProvNov2024.RData")
# Reconstruct the matched data by joining the pairs back to the original tables - 532
reconstructed_matched_data <- all_matched_pairs %>%
left_join(hs2, by = "join_key") %>%
left_join(gsrp_cdc_join, by = "License", suffix = c("_hs", "_mi"))
names(reconstructed_matched_data)
View(gsq_nov24)
View(gsq_laraCapActiv)
names(final_joined)
totals = apply(final_joined[,11:42], 2, sum, na.rm=T)
# totals
totals = apply(final_df[c(11:42)], 2, sum, na.rm=T)
totals
final_joined_small <- final_joined %>%
mutate(CapEHS02 = CapEHS02 + CapAianEHS02 + CapMigrEHS02,
CapHS35 = CapHS35 + CapAianHS35 + CapMigrHS35,
CapHS05 = CapHS05 + CapAianHS05 + CapMigrHS05,
QCapEHS02 = QCapEHS02 + QCapAianEHS02 + QCapMigrEHS02,
QCapHS35 = QCapHS35 + QCapAianHS35 + QCapMigrHS35,
QCapHS05 = QCapHS05 + QCapAianHS05 + QCapMigrHS05
) %>%
select(
LicNo,ProvName,Address,City,County,State,Zip,LicType,AgeGroup,ProvQual,
Cap02,Cap35,Cap05,CapSTSub02,CapSTSub35,CapSTSub05,CapEHS02,CapHS35,CapHS05,CapSTSubPreK,
QCap02,QCap35,QCap05,QCapSTSub02,QCapSTSub35,QCapSTSub05,QCapEHS02,QCapHS35,QCapHS05,QCapSTSubPreK,
Lat = st_coordinates(final_joined)[,2],
Lon = st_coordinates(final_joined)[,1])
final_joined$coords = st_coordinates(final_joined)
View(final_joined)
names(final_joined)
head(final_joined$coords[,1])
final_joined_small <- final_joined %>%
mutate(CapEHS02 = CapEHS02 + CapAianEHS02 + CapMigrEHS02,
CapHS35 = CapHS35 + CapAianHS35 + CapMigrHS35,
CapHS05 = CapHS05 + CapAianHS05 + CapMigrHS05,
QCapEHS02 = QCapEHS02 + QCapAianEHS02 + QCapMigrEHS02,
QCapHS35 = QCapHS35 + QCapAianHS35 + QCapMigrHS35,
QCapHS05 = QCapHS05 + QCapAianHS05 + QCapMigrHS05
) %>%
select(
LicNo,ProvName,Address,City,County,State,Zip,LicType,AgeGroup,ProvQual,
Cap02,Cap35,Cap05,CapSTSub02,CapSTSub35,CapSTSub05,CapEHS02,CapHS35,CapHS05,CapSTSubPreK,
QCap02,QCap35,QCap05,QCapSTSub02,QCapSTSub35,QCapSTSub05,QCapEHS02,QCapHS35,QCapHS05,QCapSTSubPreK,
Lat = coords[,2],
Lon = coords[,1])
library(tidyr)
final_joined_small <- final_joined %>%
mutate(CapEHS02 = CapEHS02 + CapAianEHS02 + CapMigrEHS02,
CapHS35 = CapHS35 + CapAianHS35 + CapMigrHS35,
CapHS05 = CapHS05 + CapAianHS05 + CapMigrHS05,
QCapEHS02 = QCapEHS02 + QCapAianEHS02 + QCapMigrEHS02,
QCapHS35 = QCapHS35 + QCapAianHS35 + QCapMigrHS35,
QCapHS05 = QCapHS05 + QCapAianHS05 + QCapMigrHS05
) %>%
mutate(Geom = gsub('[()Â°]', '', geometry)) %>%
separate(col = Geom, into = c('Lat', 'Lon'), sep = '\\,') %>%
select(
LicNo,ProvName,Address,City,County,State,Zip,LicType,AgeGroup,ProvQual,
Cap02,Cap35,Cap05,CapSTSub02,CapSTSub35,CapSTSub05,CapEHS02,CapHS35,CapHS05,CapSTSubPreK,
QCap02,QCap35,QCap05,QCapSTSub02,QCapSTSub35,QCapSTSub05,QCapEHS02,QCapHS35,QCapHS05,QCapSTSubPreK,
Lat,
Lon)
View(final_joined_small)
# final provider file - 7759
final_joined <- st_as_sf(final_joined, coords = c("Lon", "Lat"), crs = "EPSG:4326")
names(final_joined)
# 7759 rows & 46 var (after ensuring that the vars are matching)
final_joined = dplyr::bind_rows(noblank_lic, blank_lic1)
# final provider file - 7759
final_joined <- st_as_sf(final_joined, coords = c("Lon", "Lat"), crs = "EPSG:4326")
names(final_joined)
final_joined_small <- final_joined %>%
mutate(CapEHS02 = CapEHS02 + CapAianEHS02 + CapMigrEHS02,
CapHS35 = CapHS35 + CapAianHS35 + CapMigrHS35,
CapHS05 = CapHS05 + CapAianHS05 + CapMigrHS05,
QCapEHS02 = QCapEHS02 + QCapAianEHS02 + QCapMigrEHS02,
QCapHS35 = QCapHS35 + QCapAianHS35 + QCapMigrHS35,
QCapHS05 = QCapHS05 + QCapAianHS05 + QCapMigrHS05,
Lat = st_coordinates(.)[,1],
Lon = st_coordinates(.)[,2]
) %>%
select(
LicNo,ProvName,Address,City,County,State,Zip,LicType,AgeGroup,ProvQual,
Cap02,Cap35,Cap05,CapSTSub02,CapSTSub35,CapSTSub05,CapEHS02,CapHS35,CapHS05,CapSTSubPreK,
QCap02,QCap35,QCap05,QCapSTSub02,QCapSTSub35,QCapSTSub05,QCapEHS02,QCapHS35,QCapHS05,QCapSTSubPreK,
Lat,Lon)
View(final_joined_small)
View(final_joined_small)
final_joined_small <- final_joined %>%
mutate(CapEHS02 = CapEHS02 + CapAianEHS02 + CapMigrEHS02,
CapHS35 = CapHS35 + CapAianHS35 + CapMigrHS35,
CapHS05 = CapHS05 + CapAianHS05 + CapMigrHS05,
QCapEHS02 = QCapEHS02 + QCapAianEHS02 + QCapMigrEHS02,
QCapHS35 = QCapHS35 + QCapAianHS35 + QCapMigrHS35,
QCapHS05 = QCapHS05 + QCapAianHS05 + QCapMigrHS05,
Lat = st_coordinates(.)[,2],
Lon = st_coordinates(.)[,1]
) %>%
select(
LicNo,ProvName,Address,City,County,State,Zip,LicType,AgeGroup,ProvQual,
Cap02,Cap35,Cap05,CapSTSub02,CapSTSub35,CapSTSub05,CapEHS02,CapHS35,CapHS05,CapSTSubPreK,
QCap02,QCap35,QCap05,QCapSTSub02,QCapSTSub35,QCapSTSub05,QCapEHS02,QCapHS35,QCapHS05,QCapSTSubPreK,
Lat,Lon)
plot(final_joined_small[,"Cap05"])
# Writing 7759 features with 44 fields and geometry type Point
# st_write(final_joined, "E:/2024_Nov27_Received/Final Data/Nov2024.gdb", layer="mi_prov_new", driver="OpenFileGDB", append=FALSE)
st_write(final_joined, "E:/2024_Nov27_Received/Final Data/Nov2024_new.gpkg", layer="mi_prov_new", append=FALSE)
# Writing 7759 features with 44 fields and geometry type Point
# st_write(final_joined, "E:/2024_Nov27_Received/Final Data/Nov2024.gdb", layer="mi_prov_new", driver="OpenFileGDB", append=FALSE) # moved it to archive
st_write(final_joined_small, "E:/2024_Nov27_Received/Final Data/Nov2024_new.gpkg", layer="mi_prov_new", append=FALSE)
write.csv(final_joined_small, "E:/2024_Nov27_Received/Final Data/miProv_Nov2024.csv", row.names = F)
class(final_joined_small)
table(is.na(final_joined_small$County))
names(final_joined_small)
totals_small = apply(final_joined_small[c(11:30)], 2, sum, na.rm=T)
final_joined_small_df <- st_geometry(final_joined_small) = NULL
final_joined_small_df <- final_joined_small
st_geometry(final_joined_small_df) = NULL
final_joined_small_df <- final_joined_small
st_geometry(final_joined_small_df) = NULL
totals_small = apply(final_joined_small_df[c(11:30)], 2, sum, na.rm=T)
totals_small
28046+554+1746
save.image("E:/2024_Nov27_Received/Processed Data/miProvNov2024.RData")
table(is.na(final_joined_small$CapSTSubPreK))
table(final_joined_small$CapSTSubPreK < 1)
View(gsrp_aug2024)
1312-47
1265-1179
# check inner join between gsrp_aug2024 and cdc_join - 1265 of 1312 prov matched - 47 not joined
tmp = inner_join(gsrp_aug2024, cdc_join, join_by(x$"License #" == y$License))
View(tmp)
table(tmp$`Actual Enrollment` < 1)
table(is.na(tmp$`Actual Enrollment`))
length(unique(tmp$formatted_address))
1265-1242
library(sf)
library(dplyr) # left_join
library(tigris)
options(tigris_use_cache = TRUE)
library(ggplot2)
library(areal) # aw_interpolate
options(scipen = 999) # turn off scientific notation
setwd("C:/Users/prao/OneDrive - IFF/Investing in America - DRWP EPIC/Data Analysis/Quantitative/Working files")
# read cleaned up provider data for the 7 counties
prov = sf::st_read(dsn = "E:/2024_Nov27_Received/Final Data/Nov2024_new.gpkg", layer="mi_prov_new") # 2785 prov; NAD83 - EPSG:4269
names(prov)
st_crs(prov)
# read MI counties and subset them to the 7 counties
# cb = TRUE to get simplified geometries - also removes the parts of tracts that are in water
# these layers have EPSG 4269 (NAD83)
mi_counties = counties(state="MI", cb=TRUE, year=2024, class="sf") # 83
drwp_county = mi_counties[mi_counties$NAME %in% c('Wayne', 'Oakland', 'Macomb', 'Washtenaw', 'Livingston', 'Monroe', 'St. Clair'), ]
drwp_county = drwp_county[, c("GEOID", "NAMELSAD", "geometry")]
# remove the word County in the County field
drwp_county$NAMELSAD = gsub("County", "", drwp_county$NAMELSAD)
drwp_county$NAMELSAD = trimws(drwp_county$NAMELSAD)
# read tracts in MI and subset them to the 7 counties
mi_tracts = tracts(state="MI",  cb=TRUE, year=2024, class="sf") # 2971;
drwp_tracts = st_intersection(mi_tracts, drwp_county) # 1475
drwp_tracts = drwp_tracts[, c("GEOID","TRACTCE", "NAMELSAD.1", "geometry")]
names(drwp_tracts)[3] <- "County"
View(drwp_tracts)
unique(drwp_tracts$County)
# visualize the tracts in the 7 counties
ggplot() +
geom_sf(data = drwp_tracts, fill=NA, color="blue",linetype="dashed") +
geom_sf(data = drwp_county, fill=NA, color="red", size=4)
# visualize the tracts in the 7 counties
ggplot() +
geom_sf(data = drwp_tracts, fill=NA, color="blue",linetype="dashed") +
geom_sf(data = drwp_county, fill=NA, color="red", size=5)
# read minor civil divisions (MCDs) in MI and subset them to the 7 counties
mi_mcd = county_subdivisions(state = "MI", cb = TRUE, year=2024, class="sf") # 1540 minor civil divisions
mi_mcd = mi_mcd[, c("GEOID", "NAME", "NAMELSADCO")]
drwp_mcd = st_intersection(mi_mcd, drwp_county) # 215
drwp_mcd = drwp_mcd[,c("GEOID", "NAME", "NAMELSAD", "geometry")]
names(drwp_mcd)[3] <- "County"
drwp_mcd = st_cast(drwp_mcd, "MULTIPOLYGON") # get rid of multiple geometry types
# visualize the MCDs in the 7 counties
ggplot() +
geom_sf(data = drwp_mcd, fill=NA, color="blue",linetype="dashed") +
geom_sf(data = drwp_county, fill=NA, color="red", size=4)
# visualize the tracts in the 7 counties
ggplot() +
geom_sf(data = drwp_tracts, fill=NA, color="blue",linetype="dashed") +
geom_sf(data = drwp_county, fill=NA, color="red", linewidth=2)
# visualize the tracts in the 7 counties
ggplot() +
geom_sf(data = drwp_county, fill=NA, color="red", linewidth=2) +
geom_sf(data = drwp_tracts, fill=NA, color="blue",linetype="dashed")
# visualize the tracts in the 7 counties
ggplot() +
geom_sf(data = drwp_county, fill=NA, color="red", linewidth=2) +
geom_sf(data = drwp_tracts, fill=NA, color="blue",linewidth=0.75)
# visualize the MCDs in the 7 counties
ggplot() +
geom_sf(data = drwp_county, fill=NA, color="red", linewidth=2) +
geom_sf(data = drwp_mcd, fill=NA, color="blue",linewidth=0.75) +
# IFF ECE Demand 2024 table - 18804 obs
iffDmd2024 = read.csv("Z:/Research and Evaluation/ArcGIS/Data/1- All IFF States/Tables/ECE Demand/2024/demandData2024.csv")
# visualize the MCDs in the 7 counties
ggplot() +
geom_sf(data = drwp_county, fill=NA, color="red", linewidth=2) +
geom_sf(data = drwp_mcd, fill=NA, color="blue",linewidth=0.75) +
# IFF ECE Demand 2024 table - 18804 obs
iffDmd2024 = read.csv("Z:/Research and Evaluation/ArcGIS/Data/1- All IFF States/Tables/ECE Demand/2024/demandData2024.csv")
# visualize the MCDs in the 7 counties
ggplot() +
geom_sf(data = drwp_county, fill=NA, color="red", linewidth=2) +
geom_sf(data = drwp_mcd, fill=NA, color="blue",linewidth=0.75)
# IFF ECE Demand 2024 table - 18804 obs
iffDmd2024 = read.csv("Z:/Research and Evaluation/ArcGIS/Data/1- All IFF States/Tables/ECE Demand/2024/demandData2024.csv")
# extract demand data for the 7 counties as a spatial layer
iffDmd2024$CensTract = as.character(iffDmd2024$CensTract)
drwp_dmd = left_join(drwp_tracts[,"GEOID"], iffDmd2024, by = c("GEOID" = "CensTract")) # NAD83, EPSG:4269
rm(iffDmd2024)
rm(mi_tracts, mi_mcd, mi_counties)
st_crs(drwp_dmd)
# st_join used to join attributes from one spatial object to another based on a spatial relationship
prov = st_transform(prov_small, st_crs(drwp_dmd))
# st_join used to join attributes from one spatial object to another based on a spatial relationship
prov = st_transform(prov, st_crs(drwp_dmd))
supDmd <- st_join(prov, drwp_dmd)
# for each unique tract (GEOID) in supDmd, i want to sum all the fields that have "Cap" in their names and add the frequency of rows occurring in each tract
# Select only the columns that contain "cap" in their names
cap_columns <- names(supDmd)[grepl("Cap", names(supDmd))]
cap_columns
# Summarize the data by tract polygon - 1104 of 1475 tracts
tractSup <- supDmd %>%
group_by(GEOID) %>%  # Group by polygon geometry
summarise(prov = n(), # count no. of providers per polygon
qprov = sum(ProvQual > 2), # count no. of quality providers per polygon
across(all_of(cap_columns), \(x) sum(x, na.rm = TRUE)))  # Sum the "Cap" columns
View(tractSup)
# join tractSup to drwp_dmd to get the tract-level demand data and county names
st_geometry(tractSup) = NULL # remove geometry first
tractEce = left_join(drwp_dmd, tractSup, join_by(x$GEOID == y$GEOID))
names(tractEce)
class(tractEce)
## tract-level ECE supply and demand data - retaining only the final fields
tractEce1 <- as.data.frame(tractEce) %>%
select(TractID = GEOID, County = CountyName, NumProv = prov, NumQProv = qprov,
Cap02, Cap35, Cap05, CapSTSub02, CapSTSub35, CapSTSub05, CapEHS02, CapHS35, CapHS05, CapSTSubPreK,
QCap02, QCap35, QCap05, QCapSTSub02, QCapSTSub35, QCapSTSub05, QCapEHS02, QCapHS35, QCapHS05, QCapSTSubPreK,
EsrAge02, EsrAge35, EsrAge05, DmdSTSub02, DmdSTSub35, DmdSTSub05, DmdEHS02, DmdHS35, DmdHS05, DmdSTSubPreK)
# remove prov data and save the workspace
save.image("mi_7county_ece_gaps.RData")
View(tractEce1)
View(supDmd)
View(supDmd)
plot(prov[,"Cap05"])
View(supDmd)
plot(tractSup[,"prov"])
class(tractSup)
class(supDmd)
plot(supDmd[,"EsrAge05"])
ggplot() +
geom_sf(data = drwp_county, fill=NA, color="red", linewidth=2) +
geom_sf(data = supDmd, fill=NA, color="blue",linewidth=0.75)
supDmd <- st_intersection(prov, drwp_dmd)
class(prov)
class(drwp_dmd)
supDmd <- st_filter(prov, drwp_dm, .predicate=st_within)
supDmd <- st_filter(prov, drwp_dmd, .predicate=st_within)
ggplot() +
geom_sf(data = drwp_county, fill=NA, color="red", linewidth=2) +
geom_sf(data = supDmd, fill=NA, color="blue",linewidth=0.75)
# visualize supDmd
ggplot() +
geom_sf(data = supDmd, fill=NA, color="blue") +
geom_sf(data = drwp_county, fill=NA, color="red", linewidth=2)
table(is.na(supDmd$LicNo))
# for each unique tract (GEOID) in supDmd, i want to sum all the fields that have "Cap" in their names and add the frequency of rows occurring in each tract
# Select only the columns that contain "cap" in their names
cap_columns <- names(supDmd)[grepl("Cap", names(supDmd))]
cap_columns
# Summarize the data by tract polygon - 1100 of 1475 tracts
tractSup <- supDmd %>%
group_by(GEOID) %>%  # Group by polygon geometry
summarise(prov = n(), # count no. of providers per polygon
qprov = sum(ProvQual > 2), # count no. of quality providers per polygon
across(all_of(cap_columns), \(x) sum(x, na.rm = TRUE)))  # Sum the "Cap" columns
names(supDmd)
drwp_prov <- st_filter(prov, drwp_county, .predicate=st_within)
plot(drwp_dmd[,"EsrAge05"])
supDmd = st_join(drwp_prov, drwp_dmd)
View(supDmd)
length(unique(supDmd$LicNo))
length(unique(drwp_prov$LicNo))
supDmd[duplicated(supDmd$LicNo),]
tmp = supDmd[duplicated(supDmd$LicNo),]
View(tmp)
View(drwp_prov)
# visualize supDmd
ggplot() +
geom_sf(data = supDmd, fill=NA, color="blue") +
geom_sf(data = drwp_county, fill=NA, color="red", linewidth=2)
# for each unique tract (GEOID) in supDmd, i want to sum all the fields that have "Cap" in their names and add the frequency of rows occurring in each tract
# Select only the columns that contain "cap" in their names
cap_columns <- names(supDmd)[grepl("Cap", names(supDmd))]
names(supDmd)
# Summarize the data by tract polygon - 1100 of 1475 tracts
tractSup <- supDmd %>%
group_by(GEOID) %>%  # Group by polygon geometry
summarise(prov = n(), # count no. of providers per polygon
qprov = sum(ProvQual > 2), # count no. of quality providers per polygon
across(all_of(cap_columns), \(x) sum(x, na.rm = TRUE)))  # Sum the "Cap" columns
# join tractSup to drwp_dmd to get the tract-level demand data and county names
st_geometry(tractSup) = NULL # remove geometry first
tractEce = left_join(drwp_dmd, tractSup, join_by(x$GEOID == y$GEOID))
## tract-level ECE supply and demand data - retaining only the final fields
tractEce1 <- as.data.frame(tractEce) %>%
select(TractID = GEOID, County = CountyName, NumProv = prov, NumQProv = qprov,
Cap02, Cap35, Cap05, CapSTSub02, CapSTSub35, CapSTSub05, CapEHS02, CapHS35, CapHS05, CapSTSubPreK,
QCap02, QCap35, QCap05, QCapSTSub02, QCapSTSub35, QCapSTSub05, QCapEHS02, QCapHS35, QCapHS05, QCapSTSubPreK,
EsrAge02, EsrAge35, EsrAge05, DmdSTSub02, DmdSTSub35, DmdSTSub05, DmdEHS02, DmdHS35, DmdHS05, DmdSTSubPreK)
names(tractEce1)
tractGap = cbind(tractEce1[,1:4], # "TractID","County","NumProv","NumQProv"
tractEce1[,5:14] - tractEce1[,25:34], # gap fields; supply minus demand
tractEce1[,15:24] - tractEce1[,25:34], # quality gap fields; quality supply minus demand
tractEce1[,5:14], # supply fields
tractEce1[,15:24], # quality supply fields
tractEce1[,25:34]) # demand fields
names(tractGap)
# names for gap, quality gap, supply, quality supply, and demand fields
finalNames = c('TractID', 'County', 'NumProv', 'NumQProv',
'Gap02', 'Gap35', 'Gap05', 'STSubGap02', 'STSubGap35', 'STSubGap05', 'EHSGap02', 'HSGap35', 'EHSHSGap05', 'STSubPreKGap',
'QGap02', 'QGap35', 'QGap05', 'QSTSubGap02', 'QSTSubGap35', 'QSTSubGap05', 'QEHSGap02', 'QHSGap35', 'QEHSHSGap05', 'QSTSubPreKGap',
'Cap02', 'Cap35', 'Cap05', 'CapSTSub02', 'CapSTSub35', 'CapSTSub05', 'CapEHS02', 'CapHS35', 'CapHS05', 'CapSTSubPreK',
'QCap02', 'QCap35', 'QCap05', 'QCapSTSub02', 'QCapSTSub35', 'QCapSTSub05', 'QCapEHS02', 'QCapHS35', 'QCapHS05', 'QCapSTSubPreK',
'EsrAge02', 'EsrAge35', 'EsrAge05', 'DmdSTSub02', 'DmdSTSub35', 'DmdSTSub05', 'DmdEHS02', 'DmdHS35', 'DmdHS05', 'DmdSTSubPreK')
# apply final fieldnames
names(tractGap) = finalNames
View(tractGap)
# remove the word County in the County field
tractGap$County = gsub("County", "", tractGap$County)
tractGap$County = trimws(tractGap$County)
View(tractGap)
# round off estimates to 0 decimal places
tractGap[,5:54] = round(tractGap[,5:54],0)
# create spatial layer by joining to  the tract layer
allTractGap = left_join(drwp_tracts[,"GEOID"], tractGap, join_by(x$GEOID == y$TractID))
# rename GEOID to TractID
names(allTractGap) = gsub("GEOID", "TractID", names(allTractGap))
# check for multiple geometry types before writing to feature class layer
unique(st_geometry_type(allTractGap)) # [1] POLYGON      MULTIPOLYGON
allTractGap = st_cast(allTractGap, "MULTIPOLYGON")
allTractGap = st_transform(allTractGap, crs="EPSG:4269")
plot(allTractGap[,"Gap05"])
ggplot() +
geom_sf(data = drwp_prov, fill=NA, color="blue") +
geom_sf(data = allTractGap, fill=Gap05)
ggplot() +
geom_sf(data = drwp_prov, fill=NA, color="blue") +
geom_sf(data = allTractGap, fill='Gap05')
st_write(obj = allTractGap, dsn="DrwpEceGap.gdb", layer="allTractGap", driver="OpenFileGDB", append=FALSE)
########### summarize tract-level demand and supply to county level and calculate county-level ECE gaps
# Select only the Supply and Demand columns
tractSupDmd = allTractGap[, c('TractID', 'County', 'NumProv', 'NumQProv',
'Cap02', 'Cap35', 'Cap05', 'CapSTSub02', 'CapSTSub35', 'CapSTSub05', 'CapEHS02', 'CapHS35', 'CapHS05', 'CapSTSubPreK',
'QCap02', 'QCap35', 'QCap05', 'QCapSTSub02', 'QCapSTSub35', 'QCapSTSub05', 'QCapEHS02', 'QCapHS35', 'QCapHS05', 'QCapSTSubPreK',
'EsrAge02', 'EsrAge35', 'EsrAge05', 'DmdSTSub02', 'DmdSTSub35', 'DmdSTSub05', 'DmdEHS02', 'DmdHS35', 'DmdHS05', 'DmdSTSubPreK')]
st_geometry(tractSupDmd) <- NULL
# Summarize the supply and demand data by County
countySupDmd <- tractSupDmd %>%
group_by(County) %>%  # Group by County
summarise(across(colnames(tractSupDmd)[3:34], ~ sum(.x, na.rm = TRUE)))
View(countySupDmd)
colnames(tractSupDmd)
names(countySupDmd)
allCountyGap = cbind(countySupDmd[,1:3],
countySupDmd[,4:13] - countySupDmd[,24:33], # supply - demand
countySupDmd[,14:23] - countySupDmd[,24:33], # quality supply - demand
countySupDmd[,4:33]) # supply, quality supply, demand fields
names(allCountyGap)
# change to corresponding gap names
names(allCountyGap)[4:23] = c('Gap02', 'Gap35', 'Gap05', 'STSubGap02', 'STSubGap35', 'STSubGap05', 'EHSGap02', 'HSGap35', 'EHSHSGap05', 'STSubPreKGap',
'QGap02', 'QGap35', 'QGap05', 'QSTSubGap02', 'QSTSubGap35', 'QSTSubGap05', 'QEHSGap02', 'QHSGap35', 'QEHSHSGap05', 'QSTSubPreKGap')
names(allCountyGap)
# create spatial layer by joining to mi_counties layer
allCountyGap = left_join(drwp_county[,c("NAMELSAD", "geometry")], allCountyGap, join_by(x$NAMELSAD == y$County))
# rename NAME to County
names(allCountyGap) = gsub("NAMELSAD", "County", names(allCountyGap))
View(allCountyGap)
# check for multiple geometry types before writing to feature class layer
unique(st_geometry_type(allCountyGap)) # [1] MULTIPOLYGON
allCountyGap = st_transform(allCountyGap, crs="EPSG:4269")
st_write(obj = allCountyGap, dsn="DrwpEceGap.gdb", layer="allCountyGap", driver="OpenFileGDB", append=FALSE)
View(supDmd)
table(is.na(drwp_dmd))
########### interpolate tract-level demand to mcd-level, summarize supply to mcd-level and calculate mcd-level ECE gaps
# Note the GEOID is unique (215 values - same as # poly) but not MCD NAME (191 values < # poly)
## MCD demand
# replace NA with 0 (for interpolation to work)
drwp_dmd[is.na(drwp_dmd)] <- 0
# demand var
vars_to_apportion = c('EsrAge02', 'EsrAge35', 'EsrAge05', 'DmdSTSub02', 'DmdSTSub35', 'DmdSTSub05', 'DmdEHS02', 'DmdHS35', 'DmdHS05', 'DmdSTSubPreK')
# before running aw_interpolate(), use ar_validate() with the verbose = TRUE argument
ar_validate(
source = allTractGap,
target = drwp_mcd,
varList = vars_to_apportion,
verbose = TRUE
)
# this proj sys fixed the error: "CRS is Planar     FALSE
drwp_mcd = st_transform(drwp_mcd, crs="ESRI:102690")
allTractGap = st_transform(allTractGap, crs="ESRI:102690")
# before running aw_interpolate(), use ar_validate() with the verbose = TRUE argument
ar_validate(
source = allTractGap,
target = drwp_mcd,
varList = vars_to_apportion,
verbose = TRUE
)
# interpolation from tract to MCD estimates
mcdDmd <- aw_interpolate(drwp_mcd,
tid = GEOID,
source = allTractGap,
sid = TractID,
weight = "total",
output = "sf",
extensive = vars_to_apportion)
names(mcdDmd)
# MCD supply
# spatial join to associate provider point locations with MCD demand layer
drwp_prov = st_transform(drwp_prov, crs="ESRI:102690")
mcdSup <- st_join(drwp_prov, drwp_mcd)
View(mcdSup)
# Summarize the data by MCD polygons - 182 of 215 MCDs have prov
mcdSup <- mcdSup %>%
group_by(GEOID) %>%  # Group by polygon geometry
summarise(prov = n(), # count no. of providers per polygon
qprov = sum(ProvQual > 2), # count no. of quality providers per polygon
across(all_of(cap_columns), \(x) sum(x, na.rm = TRUE)))  # Sum the "Cap" columns
View(mcdSup)
View(mcdSup)
plot(mcdSup[,"Cap05"])
mcdSup_df <- mcdSup
st_geometry(mcdSup_df) <- NULL
# join MCD supply and demand to calculate gaps
mcdEce = left_join(mcdDmd, mcdSup_df, join_by(x$GEOID==y$GEOID))
names(mcdEce)
# not sure why the order of the field names changed
mcdDmd = mcdDmd[,c('GEOID', 'NAME', 'County', 'EsrAge02', 'EsrAge35', 'EsrAge05', 'DmdSTSub02', 'DmdSTSub35', 'DmdSTSub05', 'DmdEHS02', 'DmdHS35', 'DmdHS05', 'DmdSTSubPreK','geometry')]
# join MCD supply and demand to calculate gaps
mcdEce = left_join(mcdDmd, mcdSup_df, join_by(x$GEOID==y$GEOID))
# final MCD layer with gaps (supply - demand), quality gaps and combining supply, quality supply and demand fields
st_geometry(mcdEce) <- NULL
# convert NA to 0 so that gap calculated is not NA
mcdEce[is.na(mcdEce)] <- 0
names(mcdEce)
mcdEceGap = cbind(mcdEce[,c(1:3,14:15)], # ID fields, prov & qprov
mcdEce[,16:25] - mcdEce[,4:13], # gap fields; supply minus demand
mcdEce[,26:35] - mcdEce[,4:13], # quality gap fields; quality supply minus demand
mcdEce[,16:25], # supply fields
mcdEce[,26:35], # quality supply fields
mcdEce[,4:13]) # demand fields
names(mcdEceGap)
# names for gap, quality gap, supply, quality supply, and demand fields
names(mcdEceGap) = c('GEOID', 'MCD', 'County', 'NumProv', 'NumQProv',
'Gap02', 'Gap35', 'Gap05', 'STSubGap02', 'STSubGap35', 'STSubGap05', 'EHSGap02', 'HSGap35', 'EHSHSGap05', 'STSubPreKGap',
'QGap02', 'QGap35', 'QGap05', 'QSTSubGap02', 'QSTSubGap35', 'QSTSubGap05', 'QEHSGap02', 'QHSGap35', 'QEHSHSGap05', 'QSTSubPreKGap',
'Cap02', 'Cap35', 'Cap05', 'CapSTSub02', 'CapSTSub35', 'CapSTSub05', 'CapEHS02', 'CapHS35', 'CapHS05', 'CapSTSubPreK',
'QCap02', 'QCap35', 'QCap05', 'QCapSTSub02', 'QCapSTSub35', 'QCapSTSub05', 'QCapEHS02', 'QCapHS35', 'QCapHS05', 'QCapSTSubPreK',
'EsrAge02', 'EsrAge35', 'EsrAge05', 'DmdSTSub02', 'DmdSTSub35', 'DmdSTSub05', 'DmdEHS02', 'DmdHS35', 'DmdHS05', 'DmdSTSubPreK')
# round off estimates
mcdEceGap[,6:55] = round(mcdEceGap[,6:55],0)
# write spatial MCD layer with all gap, supply, demand data
allMcdGap = left_join(drwp_mcd[,c("GEOID","geometry")], mcdEceGap, join_by(x$GEOID==y$GEOID))
allMcdGap = st_transform(allMcdGap, crs="EPSG:4269")
unique(st_geometry_type(allMcdGap)) # check if there are multiple geometries
st_write(obj = allMcdGap, dsn="DrwpEceGap.gdb", layer="allMcdGap", driver="OpenFileGDB", append=FALSE)
plot(mcdEceGap[,"Gap05"])
plot(allMcdGap[,"Gap05"])
# remove prov data and save the workspace
save.image("mi_7county_ece_gaps.RData")
setwd("C:/Users/prao/OneDrive - IFF/Investing in America - DRWP EPIC/Data Analysis/Quantitative/Working files")
load("mi_7county_ece_gaps.RData")
# remove prov data and save the workspace
save.image("mi_7county_ece_gaps.RData")
# if(!require(leaflet)) install.packages("leaflet")
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(fuzzyjoin)
library(stringdist)
library(tidyverse)
library(data.table) # %ilike%
library(tidygeocoder)
library(usethis)
library(leaflet)
library(sf)
library(tigris)
options(tigris_use_cache = TRUE)
load("E:/2024_Nov27_Received/Processed Data/miProvNov2024.RData")
## Nov 14, 2025 - manually edited the E:\2024_Nov27_Received\Final Data\miProv_Nov2024.xlsx - final MI prov = 7581
updatedMiProv = read_excel("E:/2024_Nov27_Received/Final Data/miProv_Nov2024.xlsx", col_names = T, trim_ws = T)
names(updatedMiProv)
updatedMiProv <- st_as_sf(updatedMiProv, coords = c("Lon", "Lat"), crs = "EPSG:4326")
class(updatedMiProv)
# visualize the points
ggplot() +
geom_sf(data = updatedMiProv, fill=NA, color="red", size=4)
# write to geopackage
st_write(updatedMiProv, "E:/2024_Nov27_Received/Final Data/Nov2024_new.gpkg", layer="mi_prov_new", append=FALSE)
save.image("E:/2024_Nov27_Received/Processed Data/miProvNov2024.RData")
